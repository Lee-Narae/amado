<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="SJ">

	<!-- 아이디 중복 체크 -->
	<select id="idDuplicateCheck" parameterType="String" resultType="int">
		select count(*) AS n
		from tbl_member 
		where userid = #{userid}
	</select>

	<!-- 메일 중복 체크 -->
	<select id="emailDuplicateCheck" parameterType="String" resultType="int">
		select count(*) AS n
		from tbl_member 
		where email = #{email}
	</select>
	
	<!-- 회원가입 -->
	<insert id="memberRegisterEnd" parameterType="MemberVO">
		insert into tbl_member(userid, password, name, email, postcode, address, detailaddress, extraaddress, mobile, gender, birthday, registerday, lastpwdchangedate, status, memberrank, gymregisterstatus, speed, quick, power, earth, stretch, idle) 
		values(#{userid}, #{password}, #{name}, #{email}, #{postcode}, #{address}, #{detailaddress}, #{extraaddress}, #{mobile}, to_number(#{gender}), #{birthday}, default, default, default, default, default, default, default, default, default, default, default)
	</insert>


    
    <!-- 글쓰기 -->
   	<insert id="add" parameterType="BoardVO">
		insert into tbl_board(boardseq, title, content, fk_userid, registerdate, password, commentcount, viewcount, status, orgfilename, filename, filesize, fk_sportseq)
		values(seq_board.nextval, #{title}, #{content}, #{fk_userid}, default, #{password}, 0, 0, default, #{orgfilename}, #{filename} , to_number(#{filesize}), to_number(#{fk_sportseq}) )
	</insert>


	<!-- 페이징 처리를 안한 검색어가 없는 전체 동아리목록 보여주기 -->
	<select id="clubListNoSearch" parameterType="String" resultType="ClubVO">
		select clubseq, clubname, clubimg, fk_sportseq, clubtel
		 , city, local, clubgym, clubtime
		 , membercount, clubpay, clubstatus, clubscore
		 , ROW_NUMBER() over(order by clubscore desc) AS rank	
 		from tbl_club
		where clubstatus = 1
		<choose>
			<when test="params == '/club/findClub.do'">
				and fk_sportseq = 1
			</when>
			<otherwise>and fk_sportseq = to_number(#{params})</otherwise>
		</choose>
		order by clubseq desc	
	</select>
	


	<select id="getClubSearchTotalPage" parameterType="HashMap" resultType="int">
		select count(*) AS totalCount
 		from tbl_club
		where clubstatus = 1		
		<choose>
			<when test="params == '/club/findClub.do'">
				and fk_sportseq = 1
			</when>
			<otherwise>and fk_sportseq = to_number(#{params})</otherwise>
		</choose>	
		<choose>
			<when test="searchType_b == 'none'"></when>
			<when test="searchType_b == 'seoul'">
				and city like '%'||'서울'||'%'
			</when>
			<when test="searchType_b == 'busan'">
				and city like '%'||'부산'||'%'
			</when>
			<when test="searchType_b == 'daegu'">
				and city like '%'||'대구'||'%'			
			</when>
			<when test="searchType_b == 'incheon'">
				and city like '%'||'인천'||'%'
			</when>
			<when test="searchType_b == 'gwangju'">
				and city like '%'||'광주'||'%'
			</when>
			<when test="searchType_b == 'daejeon'">
				and city like '%'||'대전'||'%'
			</when>
			<when test="searchType_b == 'ulsan'">
				and city like '%'||'울산'||'%'
			</when>
			<when test="searchType_b == 'sejong'">
				and city like '%'||'세종'||'%'
			</when>
			<when test="searchType_b == 'gyeonggi'">
				and city like '%'||'경기'||'%'
			</when>
			<when test="searchType_b == 'gangwon'">
				and city like '%'||'강원'||'%'
			</when>
			<when test="searchType_b == 'chung-cheong_bukdo'">
				and city like '%'||'충청북'||'%' or city like '%'||'충북'||'%'
			</when>
			<when test="searchType_b == 'chung-cheong_namdo'">
				and city like '%'||'충청남'||'%' or city like '%'||'충남'||'%'
			</when>
			<when test="searchType_b == 'jeonbuk'">
				and city like '%'||'전라북'||'%' or city like '%'||'전북'||'%'
			</when>
			<when test="searchType_b == 'jeonnam'">
				and city like '%'||'전라남'||'%' or city like '%'||'전남'||'%'
			</when>
			<when test="searchType_b == 'gyeongbuk'">
				and city like '%'||'경상북'||'%' or city like '%'||'경북'||'%'
			</when>
			<when test="searchType_b == 'gyeongnam'">
				and city like '%'||'경상남'||'%' or city like '%'||'경남'||'%'
			</when>
			<when test="searchType_b == 'jeju'">
				and city like '%'||'제주'||'%'
			</when>
			<otherwise></otherwise>
		</choose>
		
		<if test='!searchWord.equals("")'>
		    and clubname like '%' || #{searchWord} || '%'
		</if>
					
	</select>
	
	
	
	
	<!-- // === 페이징 처리를 한 검색어가 없는 전체 동호회 보여주기 === // -->
	<select id="searchPaging" parameterType="HashMap" resultType="ClubVO">
	    SELECT clubseq, clubname, clubimg, fk_sportseq, clubtel
			 , city, local, clubgym, clubtime
			 , membercount, clubpay, clubstatus, clubscore
			 , rank	
		FROM
		(
		select row_number() over(order by clubscore desc) AS rno 
		 , clubseq, clubname, clubimg, fk_sportseq, clubtel
		 , city, local, clubgym, clubtime
		 , membercount, clubpay, clubstatus, clubscore
		 , ROW_NUMBER() over(order by clubscore desc) AS rank	
 		from tbl_club
		where clubstatus = 1
		<choose>
			<when test="params == '/club/findClub.do'">
				and fk_sportseq = 1
			</when>
			<otherwise>and fk_sportseq = to_number(#{params})</otherwise>
		</choose>
		)
		where rno between to_number(#{startRno}) and to_number(#{endRno})
		<choose>
			<when test="searchType_b == 'none'"></when>
			<when test="searchType_b == 'seoul'">
				and city like '%'||'서울'||'%'
			</when>
			<when test="searchType_b == 'busan'">
				and city like '%'||'부산'||'%'
			</when>
			<when test="searchType_b == 'daegu'">
				and city like '%'||'대구'||'%'			
			</when>
			<when test="searchType_b == 'incheon'">
				and city like '%'||'인천'||'%'
			</when>
			<when test="searchType_b == 'gwangju'">
				and city like '%'||'광주'||'%'
			</when>
			<when test="searchType_b == 'daejeon'">
				and city like '%'||'대전'||'%'
			</when>
			<when test="searchType_b == 'ulsan'">
				and city like '%'||'울산'||'%'
			</when>
			<when test="searchType_b == 'sejong'">
				and city like '%'||'세종'||'%'
			</when>
			<when test="searchType_b == 'gyeonggi'">
				and city like '%'||'경기'||'%'
			</when>
			<when test="searchType_b == 'gangwon'">
				and city like '%'||'강원'||'%'
			</when>
			<when test="searchType_b == 'chung-cheong_bukdo'">
				and city like '%'||'충청북'||'%' or city like '%'||'충북'||'%'
			</when>
			<when test="searchType_b == 'chung-cheong_namdo'">
				and city like '%'||'충청남'||'%' or city like '%'||'충남'||'%'
			</when>
			<when test="searchType_b == 'jeonbuk'">
				and city like '%'||'전라북'||'%' or city like '%'||'전북'||'%'
			</when>
			<when test="searchType_b == 'jeonnam'">
				and city like '%'||'전라남'||'%' or city like '%'||'전남'||'%'
			</when>
			<when test="searchType_b == 'gyeongbuk'">
				and city like '%'||'경상북'||'%' or city like '%'||'경북'||'%'
			</when>
			<when test="searchType_b == 'gyeongnam'">
				and city like '%'||'경상남'||'%' or city like '%'||'경남'||'%'
			</when>
			<when test="searchType_b == 'jeju'">
				and city like '%'||'제주'||'%'
			</when>
			<otherwise></otherwise>
		</choose>
		
		<if test='!searchWord.equals("")'>
		    and clubname like '%' || #{searchWord} || '%'
		</if>
		
		<choose>
			<when test="searchType_a == 'rank'">
				order by rno asc	
			</when>
			<when test="searchType_a == 'memberM'">
				order by membercount desc	
			</when>
			<when test="searchType_a == 'memberL'">
				order by membercount asc	
			</when>
			<otherwise></otherwise>
		</choose>	
	
	</select>




	<!-- 총 게시물 건수 (totalCount) 구하기 - 검색이 있을 때와 검색이 없을 때로 나뉜다. -->
	<select id="getListSearchTotalPage" parameterType="HashMap" resultType="int">
		select count(*) AS totalCount
		from tbl_board
		where status = 1 
		<choose>
			<when test='searchType == "title" and searchWord != "" '>
				and lower(title) like '%'||lower(#{searchWord})||'%'
			</when>
			<when test='searchType == "content" and searchWord != "" '>
				and lower(content) like '%'||lower(#{searchWord})||'%'
			</when>
			<when test='searchType == "title_content" and searchWord != "" '>
				and ( lower(title) like '%'||lower(#{searchWord})||'%'
				or    lower(content) like '%'||lower(#{searchWord})||'%' )
			</when>
			<when test='searchType == "fk_userid" and searchWord != "" '>
				and lower(fk_userid) like '%'||lower(#{searchWord})||'%'
			</when>
			<otherwise></otherwise>
		</choose>
	</select>
	
	<!-- 총 게시물 구하기(페이징) - 검색이 있을 때와 검색이 없을 때로 나뉜다. -->
	<select id="boardListSearchPaging" parameterType="HashMap" resultType="BoardVO">
		     select rno, boardseq, title, content, fk_userid, registerdate
				  , password, commentcount, viewcount, status
				  , orgfilename, filename, filesize, fk_sportseq
		     from
		          (
		           select row_number() over(order by boardseq desc) AS rno, 
		           		  boardseq, title, content, fk_userid
		           		, to_char(registerdate, 'yyyy-mm-dd hh24:mi:ss') AS registerdate
						, password, commentcount, viewcount, status
						, orgfilename, filename, filesize, fk_sportseq
		           from tbl_board
		           where status = 1
				   <choose>
					   <when test="params == '/community/list.do'">
					   </when>
					   <otherwise>and fk_sportseq = to_number(#{params})</otherwise>
				   </choose>
				   		             
				   <choose>
					   <when test='searchType == "title" and searchWord != "" '>
						   and lower(title) like '%'||lower(#{searchWord})||'%'
					   </when>
					   <when test='searchType == "content" and searchWord != "" '>
						   and lower(content) like '%'||lower(#{searchWord})||'%'
					   </when>
					   <when test='searchType == "title_content" and searchWord != "" '>
						   and ( lower(title) like '%'||lower(#{searchWord})||'%'
						   or    lower(content) like '%'||lower(#{searchWord})||'%' )
					   </when>
					   <when test='searchType == "fk_userid" and searchWord != "" '>
						   and lower(fk_userid) like '%'||lower(#{searchWord})||'%'
					   </when>
					   <otherwise></otherwise>
				   </choose>
		           order by registerdate desc
		           ) V
			  where rno between to_number(#{startRno}) and to_number(#{endRno})
	</select>	





	<select id="getView" parameterType="HashMap" resultType="BoardVO">
	   select previousseq, previoussubject, boardseq, fk_userid, 
	   		  title, content, viewcount, registerdate, password, nextseq, nextsubject
	    FROM
	    (
	        select lag (boardseq, 1) over(order by boardseq desc) AS previousseq
	             , lag (title, 1) over(order by boardseq desc)  AS previoussubject
	             , boardseq, fk_userid, title, content, viewcount
	             , to_char(registerdate, 'yyyy-mm-dd hh24:mi:ss') AS registerdate, password
	             , lead (boardseq, 1) over(order by boardseq desc) AS nextseq
	             , lead (title, 1) over(order by boardseq desc) AS nextsubject
	        from tbl_board
	        where status = 1
	    ) V
	    WHERE V.boardseq = #{boardseq}		
	</select>	


	<!-- === 글 조회수 1 증가하기 === -->
	<update id="increase_viewcount" parameterType="String">
		update tbl_board set viewcount = viewcount + 1
		where boardseq = #{boardseq}
	</update>



	<!-- === 댓글쓰기(tbl_comment 테이블에 insert) === -->
	<insert id="addBoardComment" parameterType="BoardCommentVO">
	<!-- 첨부파일이 없는 경우 -->
		insert into tbl_boardcomment(boardcommentseq, parentseq, comment_text, registerdate, fk_userid, status)
		values(seq_boardcomment.nextval, #{parentseq}, #{comment_text}, default, #{fk_userid}, default)
	</insert>


	<!-- 댓글 작성 시 카운트 증가 -->
	<update id="updateBoardCommentCount" parameterType="String">
			update tbl_board set commentcount = commentcount + 1
			where boardseq = #{parentseq}		
	</update>


	<!-- === 원게시물에 딸린 댓글들을 조회해오기 === -->
	<select id="readComment" parameterType="String" resultType="BoardCommentVO">
		select boardcommentseq, fk_userid, comment_text
		     , to_char(registerdate, 'yyyy-mm-dd hh24:mi:ss') as registerdate
		from tbl_boardcomment
		where status = 1 and parentseq = #{parentseq}
		order by boardcommentseq desc
	</select>
	
	<!-- 댓글 삭제 -->
	<update id="deleteComment" parameterType="String">
		update tbl_boardcomment set status = 0
		where boardcommentseq = #{boardcommentseq}
	</update>

	<!-- 댓글 삭제 시 카운트 감소 -->
	<update id="updateCommentCount_decrease" parameterType="String">
			update tbl_board set commentcount = commentcount - 1
			where boardseq = #{parentseq}		
	</update>

</mapper>